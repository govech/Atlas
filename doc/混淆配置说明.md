# Android通用框架混淆配置说明

## 概述

本文档说明Android通用框架的代码混淆配置，包括ProGuard/R8规则和优化配置。

## 配置文件清单

### 1. app模块混淆规则
**文件**: `app/proguard-rules.pro`

**配置内容**:
- 基础混淆配置（优化次数、代码优化等）
- Android基础组件保留规则
- 反射使用的类保留规则
- Hilt依赖注入混淆规则
- Kotlin相关混淆规则
- 数据模型类保留规则
- WebView相关规则
- R8优化配置
- 资源优化配置
- 调试配置

### 2. core-model模块混淆规则
**文件**: `core-model/consumer-rules.pro`

**配置内容**:
- 保留所有数据模型类
- 保留枚举类
- 保留泛型信息
- 保留密封类（DataResult、UiState）
- 保留数据类的copy和component方法

### 3. core-network模块混淆规则
**文件**: `core-network/consumer-rules.pro`

**配置内容**:
- Retrofit混淆规则（接口、注解、响应类型）
- OkHttp混淆规则（平台类、内部类、接口）
- Gson混淆规则（适配器、注解、泛型）
- 网络模块特定规则（API接口、拦截器、管理器）
- Kotlin协程相关规则

### 4. core-database模块混淆规则
**文件**: `core-database/consumer-rules.pro`

**配置内容**:
- Room数据库混淆规则
- 保留Entity实体类
- 保留DAO接口
- 保留TypeConverter
- 保留Room生成的实现类
- 数据库实体和DAO类保留规则

### 5. core-common模块混淆规则
**文件**: `core-common/consumer-rules.pro`

**配置内容**:
- 保留基础类
- 保留工具类
- 保留扩展函数
- 保留常量类
- 保留异常处理器

### 6. core-ui模块混淆规则
**文件**: `core-ui/consumer-rules.pro`

**配置内容**:
- ViewBinding混淆规则
- 自定义View混淆规则
- Activity和Fragment基类保留规则
- Adapter和ViewHolder保留规则
- Dialog保留规则
- 其他UI组件保留规则

### 7. feature-template模块混淆规则
**文件**: `feature-template/consumer-rules.pro`

**配置内容**:
- 保留数据模型类
- 保留API接口
- 保留Repository
- 保留ViewModel
- 保留Activity和Fragment
- 保留Adapter

## R8优化配置

### build.gradle.kts配置

```kotlin
buildTypes {
    release {
        // 启用代码混淆
        isMinifyEnabled = true
        // 启用资源优化
        isShrinkResources = true
        // 使用优化的ProGuard配置
        proguardFiles(
            getDefaultProguardFile("proguard-android-optimize.txt"),
            "proguard-rules.pro"
        )
    }
}

packaging {
    resources {
        // 排除重复的LICENSE文件
        excludes += "/META-INF/{AL2.0,LGPL2.1}"
        excludes += "/META-INF/LICENSE*"
        excludes += "/META-INF/NOTICE*"
    }
}
```

### R8优化特性

1. **代码优化**
   - 优化次数: 5次
   - 允许访问和修改有修饰符的类
   - 合并接口和类
   - 方法内联优化
   - 类合并优化

2. **资源优化**
   - 自动移除未使用的资源
   - 资源压缩
   - 资源去重

3. **调试支持**
   - 保留源文件名和行号信息
   - 生成混淆映射文件（mapping.txt）
   - 生成种子文件（seeds.txt）
   - 生成未使用代码报告（unused.txt）
   - 生成配置信息（configuration.txt）

## 混淆验证

### 验证步骤

1. **编译验证**
   ```bash
   ./gradlew clean
   ./gradlew app:assembleRelease
   ```

2. **安装测试**
   ```bash
   adb install app/build/outputs/apk/release/app-release.apk
   ```

3. **功能测试**
   - 测试登录功能
   - 测试用户列表功能
   - 测试用户详情功能
   - 测试网络请求
   - 测试数据库操作

4. **检查混淆映射**
   - 查看 `app/build/outputs/mapping/release/mapping.txt`
   - 确认类名和方法名已混淆

5. **检查APK大小**
   - 确认APK大小 < 50MB
   - 对比Debug版本，确认资源优化生效

## 常见问题

### 1. 混淆后崩溃

**问题**: 应用在Release版本崩溃，Debug版本正常

**解决方案**:
- 检查崩溃日志，找到被混淆的类
- 在对应模块的consumer-rules.pro中添加保留规则
- 使用mapping.txt还原混淆的类名

### 2. 反射失效

**问题**: 使用反射的代码在混淆后失效

**解决方案**:
- 在proguard-rules.pro中添加 `-keep` 规则保留反射使用的类
- 使用 `@Keep` 注解标记需要保留的类

### 3. 序列化失败

**问题**: JSON序列化/反序列化失败

**解决方案**:
- 确保数据模型类在consumer-rules.pro中被保留
- 检查Gson混淆规则是否正确配置

### 4. Hilt注入失败

**问题**: 依赖注入在混淆后失败

**解决方案**:
- 检查Hilt混淆规则是否完整
- 确保所有Hilt注解的类都被保留

## 最佳实践

1. **模块化混淆规则**
   - 每个模块维护自己的consumer-rules.pro
   - 避免在app模块中配置所有规则

2. **保留必要信息**
   - 保留行号信息，便于调试崩溃日志
   - 保留源文件名

3. **测试混淆版本**
   - 每次发布前测试Release版本
   - 使用自动化测试验证核心功能

4. **版本控制**
   - 保存每个版本的mapping.txt
   - 便于还原崩溃日志中的混淆类名

5. **持续优化**
   - 定期检查未使用的代码
   - 优化混淆规则，减小APK大小

## 参考资料

- [Android ProGuard官方文档](https://developer.android.com/studio/build/shrink-code)
- [R8优化指南](https://developer.android.com/studio/build/shrink-code#optimization)
- [Hilt混淆配置](https://dagger.dev/hilt/gradle-setup#proguard-rules)
- [Retrofit混淆配置](https://github.com/square/retrofit/blob/master/retrofit/src/main/resources/META-INF/proguard/retrofit2.pro)
- [Room混淆配置](https://developer.android.com/topic/libraries/architecture/room#proguard)
