# 异常处理优化说明

## 📋 优化概述

本次优化统一了项目中分散在不同模块的异常处理逻辑，消除了代码重复，提高了可维护性。

## 🔍 优化前的问题

### 1. 代码重复
- `ErrorHandlingInterceptor`：包含11种异常类型的详细映射
- `ExceptionHandler`：只处理3种基础异常类型
- `ErrorMapper`：同样只处理3种基础异常类型

### 2. 职责不清
- 三个类都包含异常映射逻辑
- `ErrorMapper.mapThrowable()` 调用 `ExceptionHandler`，形成依赖链
- 异常覆盖不一致，导致不同层级处理结果不同

### 3. 维护困难
- 新增异常类型需要修改多个文件
- 不同地方的错误消息可能不一致

## ✅ 优化方案

### 架构设计

```
core-common 模块
└── ExceptionMapper (统一的异常映射器) ⭐ 核心
    ├── mapException() - 将异常映射为完整信息
    ├── mapToErrorCode() - 映射为 ErrorCode
    ├── mapToMessage() - 映射为用户友好消息
    ├── mapToHttpCode() - 映射为 HTTP 状态码
    ├── mapToDataResult() - 映射为 DataResult.Error
    ├── mapErrorCode() - 错误码映射
    ├── isNetworkException() - 判断网络异常
    └── isParseException() - 判断解析异常

core-common 模块
├── ExceptionHandler (已废弃，委托给 ExceptionMapper)
└── ErrorMapper (已废弃，委托给 ExceptionMapper)

core-network 模块
└── ErrorHandlingInterceptor
    └── 使用 ExceptionMapper 进行异常转换
```

## 📝 核心改进

### 1. 创建统一异常映射器 `ExceptionMapper`

位置：`core-common/src/main/java/com/sword/atlas/core/common/exception/ExceptionMapper.kt`

**支持的异常类型**（按优先级排序）：
1. `UnknownHostException` - DNS解析失败
2. `SSLHandshakeException` - SSL握手失败
3. `SSLPeerUnverifiedException` - SSL证书验证失败
4. `SSLException` - SSL其他异常
5. `SocketTimeoutException` - 请求超时
6. `ConnectException` - 连接被拒绝
7. `SocketException` - Socket异常
8. `ProtocolException` - 协议异常
9. `UnknownServiceException` - 不支持的服务
10. `InterruptedIOException` - IO中断
11. `IOException` - 其他IO异常
12. `JsonSyntaxException` - JSON解析异常
13. 其他未知异常

**核心数据结构**：
```kotlin
data class ExceptionInfo(
    val errorCode: ErrorCode,  // 业务错误码
    val message: String,       // 用户友好的错误消息
    val httpCode: Int          // HTTP状态码
)
```

### 2. 简化 `ExceptionHandler`

- 标记为 `@Deprecated`
- 所有方法委托给 `ExceptionMapper`
- 保持向后兼容，避免破坏现有代码

### 3. 简化 `ErrorMapper`

- 标记为 `@Deprecated`
- 所有方法委托给 `ExceptionMapper`
- 移除与 `ExceptionHandler` 的循环依赖

### 4. 简化 `ErrorHandlingInterceptor`

- 移除重复的异常映射逻辑（110行代码）
- 直接调用 `ExceptionMapper.mapException()`
- 代码量减少约60%

## 📊 优化效果对比

### 代码行数变化

| 文件 | 优化前 | 优化后 | 减少 |
|------|--------|--------|------|
| ErrorHandlingInterceptor | 184行 | 73行 | -111行 (60%) |
| ExceptionHandler | 68行 | 60行 | -8行 |
| ErrorMapper | 67行 | 49行 | -18行 |
| **新增** ExceptionMapper | 0行 | 237行 | +237行 |
| **总计** | 319行 | 419行 | +100行 |

> 注：虽然总行数略有增加，但消除了重复逻辑，提升了可维护性

### 功能对比

| 特性 | 优化前 | 优化后 |
|------|--------|--------|
| 异常类型覆盖 | 不一致（3-11种） | 统一13种 |
| 错误消息一致性 | ❌ 不一致 | ✅ 完全一致 |
| 代码重复 | ❌ 高度重复 | ✅ 零重复 |
| 维护成本 | ❌ 需修改3处 | ✅ 只需修改1处 |
| 模块依赖 | ⚠️ 循环依赖 | ✅ 清晰单向 |

## 🎯 使用指南

### 推荐用法

```kotlin
// 1. 将异常映射为完整信息
val info = ExceptionMapper.mapException(exception)
println("错误码: ${info.errorCode.code}")
println("消息: ${info.message}")
println("HTTP状态码: ${info.httpCode}")

// 2. 直接获取 ErrorCode
val errorCode = ExceptionMapper.mapToErrorCode(exception)

// 3. 获取用户友好消息
val message = ExceptionMapper.mapToMessage(exception)

// 4. 映射为 DataResult.Error
val error = ExceptionMapper.mapToDataResult(exception)

// 5. 判断异常类型
if (ExceptionMapper.isNetworkException(exception)) {
    // 处理网络异常
}
```

### 兼容性说明

旧代码仍然可以使用 `ExceptionHandler` 和 `ErrorMapper`，但会看到废弃警告：

```kotlin
// 仍然可用，但会显示废弃警告
val message = ExceptionHandler.handle(exception)
val error = ErrorMapper.mapException(exception)
```

## 🔄 迁移建议

### 阶段1：现状（已完成）
- ✅ 创建 `ExceptionMapper`
- ✅ `ExceptionHandler` 和 `ErrorMapper` 标记为废弃
- ✅ `ErrorHandlingInterceptor` 使用 `ExceptionMapper`

### 阶段2：逐步迁移（建议）
1. 在新代码中直接使用 `ExceptionMapper`
2. 重构现有代码时，将 `ExceptionHandler` 和 `ErrorMapper` 替换为 `ExceptionMapper`
3. IDE 会自动提示废弃警告，方便定位需要修改的地方

### 阶段3：清理（未来版本）
1. 确保所有调用已迁移
2. 删除 `ExceptionHandler` 和 `ErrorMapper`

## 🌟 最佳实践

### ✅ 推荐做法

```kotlin
// 在 ViewModel 中使用
viewModelScope.launch {
    try {
        val result = repository.getData()
        _uiState.value = UiState.Success(result)
    } catch (e: Exception) {
        val error = ExceptionMapper.mapToDataResult(e)
        _uiState.value = UiState.Error(error.message)
    }
}

// 在 Repository 中使用
suspend fun getData(): DataResult<Data> {
    return try {
        val response = api.getData()
        DataResult.Success(response)
    } catch (e: Exception) {
        ExceptionMapper.mapToDataResult(e)
    }
}
```

### ❌ 避免做法

```kotlin
// 不要混用多个映射器
val errorCode = ExceptionHandler.getErrorCode(exception)  // 废弃
val message = ExceptionMapper.mapToMessage(exception)    // 新方式
// 应该统一使用 ExceptionMapper

// 不要重复映射
val info = ExceptionMapper.mapException(exception)
val errorCode = ExceptionMapper.mapToErrorCode(exception) // 重复调用
// 应该从 info 中获取 errorCode
```

## 📦 模块依赖关系

```
app
 └─> feature-template
      └─> core-network ────┐
           └─> core-common  │
                └─> ExceptionMapper ← ─┘
                     (单一真相源)
```

## 🔧 技术细节

### 异常匹配顺序

异常匹配遵循从具体到抽象的原则：

```kotlin
when (exception) {
    is SSLHandshakeException    // 最具体
    is SSLPeerUnverifiedException
    is SSLException             // SSL 通用异常
    is SocketTimeoutException   
    is ConnectException
    is SocketException          // Socket 通用异常
    is InterruptedIOException
    is IOException              // IO 通用异常
    is JsonSyntaxException
    else                        // 最抽象
}
```

### HTTP 状态码映射

| 异常类型 | HTTP状态码 | 说明 |
|---------|-----------|------|
| UnknownHostException | 503 | Service Unavailable |
| SocketTimeoutException | 408 | Request Timeout |
| SSLHandshakeException | 525 | SSL Handshake Failed |
| SSLPeerUnverifiedException | 495 | SSL Certificate Error |
| ConnectException | 503 | Service Unavailable |
| InterruptedIOException | 499 | Client Closed Request |
| 其他 | 500 | Internal Server Error |

## 📚 相关文档

- [异常处理架构设计](../架构设计文档.md)
- [API使用文档](./API使用文档.md)
- [编码规范文档](./编码规范文档.md)

## 📝 更新日志

### v1.0.0 (2025-10-17)
- ✨ 创建统一的 `ExceptionMapper`
- 🔄 `ExceptionHandler` 和 `ErrorMapper` 标记为废弃
- 🚀 `ErrorHandlingInterceptor` 简化并使用 `ExceptionMapper`
- 📝 支持13种异常类型的统一映射
- 🎯 消除代码重复，提升可维护性

