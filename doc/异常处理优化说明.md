# å¼‚å¸¸å¤„ç†ä¼˜åŒ–è¯´æ˜

## ğŸ“‹ ä¼˜åŒ–æ¦‚è¿°

æœ¬æ¬¡ä¼˜åŒ–ç»Ÿä¸€äº†é¡¹ç›®ä¸­åˆ†æ•£åœ¨ä¸åŒæ¨¡å—çš„å¼‚å¸¸å¤„ç†é€»è¾‘ï¼Œæ¶ˆé™¤äº†ä»£ç é‡å¤ï¼Œæé«˜äº†å¯ç»´æŠ¤æ€§ã€‚

## ğŸ” ä¼˜åŒ–å‰çš„é—®é¢˜

### 1. ä»£ç é‡å¤
- `ErrorHandlingInterceptor`ï¼šåŒ…å«11ç§å¼‚å¸¸ç±»å‹çš„è¯¦ç»†æ˜ å°„
- `ExceptionHandler`ï¼šåªå¤„ç†3ç§åŸºç¡€å¼‚å¸¸ç±»å‹
- `ErrorMapper`ï¼šåŒæ ·åªå¤„ç†3ç§åŸºç¡€å¼‚å¸¸ç±»å‹

### 2. èŒè´£ä¸æ¸…
- ä¸‰ä¸ªç±»éƒ½åŒ…å«å¼‚å¸¸æ˜ å°„é€»è¾‘
- `ErrorMapper.mapThrowable()` è°ƒç”¨ `ExceptionHandler`ï¼Œå½¢æˆä¾èµ–é“¾
- å¼‚å¸¸è¦†ç›–ä¸ä¸€è‡´ï¼Œå¯¼è‡´ä¸åŒå±‚çº§å¤„ç†ç»“æœä¸åŒ

### 3. ç»´æŠ¤å›°éš¾
- æ–°å¢å¼‚å¸¸ç±»å‹éœ€è¦ä¿®æ”¹å¤šä¸ªæ–‡ä»¶
- ä¸åŒåœ°æ–¹çš„é”™è¯¯æ¶ˆæ¯å¯èƒ½ä¸ä¸€è‡´

## âœ… ä¼˜åŒ–æ–¹æ¡ˆ

### æ¶æ„è®¾è®¡

```
core-common æ¨¡å—
â””â”€â”€ ExceptionMapper (ç»Ÿä¸€çš„å¼‚å¸¸æ˜ å°„å™¨) â­ æ ¸å¿ƒ
    â”œâ”€â”€ mapException() - å°†å¼‚å¸¸æ˜ å°„ä¸ºå®Œæ•´ä¿¡æ¯
    â”œâ”€â”€ mapToErrorCode() - æ˜ å°„ä¸º ErrorCode
    â”œâ”€â”€ mapToMessage() - æ˜ å°„ä¸ºç”¨æˆ·å‹å¥½æ¶ˆæ¯
    â”œâ”€â”€ mapToHttpCode() - æ˜ å°„ä¸º HTTP çŠ¶æ€ç 
    â”œâ”€â”€ mapToDataResult() - æ˜ å°„ä¸º DataResult.Error
    â”œâ”€â”€ mapErrorCode() - é”™è¯¯ç æ˜ å°„
    â”œâ”€â”€ isNetworkException() - åˆ¤æ–­ç½‘ç»œå¼‚å¸¸
    â””â”€â”€ isParseException() - åˆ¤æ–­è§£æå¼‚å¸¸

core-common æ¨¡å—
â”œâ”€â”€ ExceptionHandler (å·²åºŸå¼ƒï¼Œå§”æ‰˜ç»™ ExceptionMapper)
â””â”€â”€ ErrorMapper (å·²åºŸå¼ƒï¼Œå§”æ‰˜ç»™ ExceptionMapper)

core-network æ¨¡å—
â””â”€â”€ ErrorHandlingInterceptor
    â””â”€â”€ ä½¿ç”¨ ExceptionMapper è¿›è¡Œå¼‚å¸¸è½¬æ¢
```

## ğŸ“ æ ¸å¿ƒæ”¹è¿›

### 1. åˆ›å»ºç»Ÿä¸€å¼‚å¸¸æ˜ å°„å™¨ `ExceptionMapper`

ä½ç½®ï¼š`core-common/src/main/java/com/sword/atlas/core/common/exception/ExceptionMapper.kt`

**æ”¯æŒçš„å¼‚å¸¸ç±»å‹**ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰ï¼š
1. `UnknownHostException` - DNSè§£æå¤±è´¥
2. `SSLHandshakeException` - SSLæ¡æ‰‹å¤±è´¥
3. `SSLPeerUnverifiedException` - SSLè¯ä¹¦éªŒè¯å¤±è´¥
4. `SSLException` - SSLå…¶ä»–å¼‚å¸¸
5. `SocketTimeoutException` - è¯·æ±‚è¶…æ—¶
6. `ConnectException` - è¿æ¥è¢«æ‹’ç»
7. `SocketException` - Socketå¼‚å¸¸
8. `ProtocolException` - åè®®å¼‚å¸¸
9. `UnknownServiceException` - ä¸æ”¯æŒçš„æœåŠ¡
10. `InterruptedIOException` - IOä¸­æ–­
11. `IOException` - å…¶ä»–IOå¼‚å¸¸
12. `JsonSyntaxException` - JSONè§£æå¼‚å¸¸
13. å…¶ä»–æœªçŸ¥å¼‚å¸¸

**æ ¸å¿ƒæ•°æ®ç»“æ„**ï¼š
```kotlin
data class ExceptionInfo(
    val errorCode: ErrorCode,  // ä¸šåŠ¡é”™è¯¯ç 
    val message: String,       // ç”¨æˆ·å‹å¥½çš„é”™è¯¯æ¶ˆæ¯
    val httpCode: Int          // HTTPçŠ¶æ€ç 
)
```

### 2. ç®€åŒ– `ExceptionHandler`

- æ ‡è®°ä¸º `@Deprecated`
- æ‰€æœ‰æ–¹æ³•å§”æ‰˜ç»™ `ExceptionMapper`
- ä¿æŒå‘åå…¼å®¹ï¼Œé¿å…ç ´åç°æœ‰ä»£ç 

### 3. ç®€åŒ– `ErrorMapper`

- æ ‡è®°ä¸º `@Deprecated`
- æ‰€æœ‰æ–¹æ³•å§”æ‰˜ç»™ `ExceptionMapper`
- ç§»é™¤ä¸ `ExceptionHandler` çš„å¾ªç¯ä¾èµ–

### 4. ç®€åŒ– `ErrorHandlingInterceptor`

- ç§»é™¤é‡å¤çš„å¼‚å¸¸æ˜ å°„é€»è¾‘ï¼ˆ110è¡Œä»£ç ï¼‰
- ç›´æ¥è°ƒç”¨ `ExceptionMapper.mapException()`
- ä»£ç é‡å‡å°‘çº¦60%

## ğŸ“Š ä¼˜åŒ–æ•ˆæœå¯¹æ¯”

### ä»£ç è¡Œæ•°å˜åŒ–

| æ–‡ä»¶ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | å‡å°‘ |
|------|--------|--------|------|
| ErrorHandlingInterceptor | 184è¡Œ | 73è¡Œ | -111è¡Œ (60%) |
| ExceptionHandler | 68è¡Œ | 60è¡Œ | -8è¡Œ |
| ErrorMapper | 67è¡Œ | 49è¡Œ | -18è¡Œ |
| **æ–°å¢** ExceptionMapper | 0è¡Œ | 237è¡Œ | +237è¡Œ |
| **æ€»è®¡** | 319è¡Œ | 419è¡Œ | +100è¡Œ |

> æ³¨ï¼šè™½ç„¶æ€»è¡Œæ•°ç•¥æœ‰å¢åŠ ï¼Œä½†æ¶ˆé™¤äº†é‡å¤é€»è¾‘ï¼Œæå‡äº†å¯ç»´æŠ¤æ€§

### åŠŸèƒ½å¯¹æ¯”

| ç‰¹æ€§ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å |
|------|--------|--------|
| å¼‚å¸¸ç±»å‹è¦†ç›– | ä¸ä¸€è‡´ï¼ˆ3-11ç§ï¼‰ | ç»Ÿä¸€13ç§ |
| é”™è¯¯æ¶ˆæ¯ä¸€è‡´æ€§ | âŒ ä¸ä¸€è‡´ | âœ… å®Œå…¨ä¸€è‡´ |
| ä»£ç é‡å¤ | âŒ é«˜åº¦é‡å¤ | âœ… é›¶é‡å¤ |
| ç»´æŠ¤æˆæœ¬ | âŒ éœ€ä¿®æ”¹3å¤„ | âœ… åªéœ€ä¿®æ”¹1å¤„ |
| æ¨¡å—ä¾èµ– | âš ï¸ å¾ªç¯ä¾èµ– | âœ… æ¸…æ™°å•å‘ |

## ğŸ¯ ä½¿ç”¨æŒ‡å—

### æ¨èç”¨æ³•

```kotlin
// 1. å°†å¼‚å¸¸æ˜ å°„ä¸ºå®Œæ•´ä¿¡æ¯
val info = ExceptionMapper.mapException(exception)
println("é”™è¯¯ç : ${info.errorCode.code}")
println("æ¶ˆæ¯: ${info.message}")
println("HTTPçŠ¶æ€ç : ${info.httpCode}")

// 2. ç›´æ¥è·å– ErrorCode
val errorCode = ExceptionMapper.mapToErrorCode(exception)

// 3. è·å–ç”¨æˆ·å‹å¥½æ¶ˆæ¯
val message = ExceptionMapper.mapToMessage(exception)

// 4. æ˜ å°„ä¸º DataResult.Error
val error = ExceptionMapper.mapToDataResult(exception)

// 5. åˆ¤æ–­å¼‚å¸¸ç±»å‹
if (ExceptionMapper.isNetworkException(exception)) {
    // å¤„ç†ç½‘ç»œå¼‚å¸¸
}
```

### å…¼å®¹æ€§è¯´æ˜

æ—§ä»£ç ä»ç„¶å¯ä»¥ä½¿ç”¨ `ExceptionHandler` å’Œ `ErrorMapper`ï¼Œä½†ä¼šçœ‹åˆ°åºŸå¼ƒè­¦å‘Šï¼š

```kotlin
// ä»ç„¶å¯ç”¨ï¼Œä½†ä¼šæ˜¾ç¤ºåºŸå¼ƒè­¦å‘Š
val message = ExceptionHandler.handle(exception)
val error = ErrorMapper.mapException(exception)
```

## ğŸ”„ è¿ç§»å»ºè®®

### é˜¶æ®µ1ï¼šç°çŠ¶ï¼ˆå·²å®Œæˆï¼‰
- âœ… åˆ›å»º `ExceptionMapper`
- âœ… `ExceptionHandler` å’Œ `ErrorMapper` æ ‡è®°ä¸ºåºŸå¼ƒ
- âœ… `ErrorHandlingInterceptor` ä½¿ç”¨ `ExceptionMapper`

### é˜¶æ®µ2ï¼šé€æ­¥è¿ç§»ï¼ˆå»ºè®®ï¼‰
1. åœ¨æ–°ä»£ç ä¸­ç›´æ¥ä½¿ç”¨ `ExceptionMapper`
2. é‡æ„ç°æœ‰ä»£ç æ—¶ï¼Œå°† `ExceptionHandler` å’Œ `ErrorMapper` æ›¿æ¢ä¸º `ExceptionMapper`
3. IDE ä¼šè‡ªåŠ¨æç¤ºåºŸå¼ƒè­¦å‘Šï¼Œæ–¹ä¾¿å®šä½éœ€è¦ä¿®æ”¹çš„åœ°æ–¹

### é˜¶æ®µ3ï¼šæ¸…ç†ï¼ˆæœªæ¥ç‰ˆæœ¬ï¼‰
1. ç¡®ä¿æ‰€æœ‰è°ƒç”¨å·²è¿ç§»
2. åˆ é™¤ `ExceptionHandler` å’Œ `ErrorMapper`

## ğŸŒŸ æœ€ä½³å®è·µ

### âœ… æ¨èåšæ³•

```kotlin
// åœ¨ ViewModel ä¸­ä½¿ç”¨
viewModelScope.launch {
    try {
        val result = repository.getData()
        _uiState.value = UiState.Success(result)
    } catch (e: Exception) {
        val error = ExceptionMapper.mapToDataResult(e)
        _uiState.value = UiState.Error(error.message)
    }
}

// åœ¨ Repository ä¸­ä½¿ç”¨
suspend fun getData(): DataResult<Data> {
    return try {
        val response = api.getData()
        DataResult.Success(response)
    } catch (e: Exception) {
        ExceptionMapper.mapToDataResult(e)
    }
}
```

### âŒ é¿å…åšæ³•

```kotlin
// ä¸è¦æ··ç”¨å¤šä¸ªæ˜ å°„å™¨
val errorCode = ExceptionHandler.getErrorCode(exception)  // åºŸå¼ƒ
val message = ExceptionMapper.mapToMessage(exception)    // æ–°æ–¹å¼
// åº”è¯¥ç»Ÿä¸€ä½¿ç”¨ ExceptionMapper

// ä¸è¦é‡å¤æ˜ å°„
val info = ExceptionMapper.mapException(exception)
val errorCode = ExceptionMapper.mapToErrorCode(exception) // é‡å¤è°ƒç”¨
// åº”è¯¥ä» info ä¸­è·å– errorCode
```

## ğŸ“¦ æ¨¡å—ä¾èµ–å…³ç³»

```
app
 â””â”€> feature-template
      â””â”€> core-network â”€â”€â”€â”€â”
           â””â”€> core-common  â”‚
                â””â”€> ExceptionMapper â† â”€â”˜
                     (å•ä¸€çœŸç›¸æº)
```

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### å¼‚å¸¸åŒ¹é…é¡ºåº

å¼‚å¸¸åŒ¹é…éµå¾ªä»å…·ä½“åˆ°æŠ½è±¡çš„åŸåˆ™ï¼š

```kotlin
when (exception) {
    is SSLHandshakeException    // æœ€å…·ä½“
    is SSLPeerUnverifiedException
    is SSLException             // SSL é€šç”¨å¼‚å¸¸
    is SocketTimeoutException   
    is ConnectException
    is SocketException          // Socket é€šç”¨å¼‚å¸¸
    is InterruptedIOException
    is IOException              // IO é€šç”¨å¼‚å¸¸
    is JsonSyntaxException
    else                        // æœ€æŠ½è±¡
}
```

### HTTP çŠ¶æ€ç æ˜ å°„

| å¼‚å¸¸ç±»å‹ | HTTPçŠ¶æ€ç  | è¯´æ˜ |
|---------|-----------|------|
| UnknownHostException | 503 | Service Unavailable |
| SocketTimeoutException | 408 | Request Timeout |
| SSLHandshakeException | 525 | SSL Handshake Failed |
| SSLPeerUnverifiedException | 495 | SSL Certificate Error |
| ConnectException | 503 | Service Unavailable |
| InterruptedIOException | 499 | Client Closed Request |
| å…¶ä»– | 500 | Internal Server Error |

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å¼‚å¸¸å¤„ç†æ¶æ„è®¾è®¡](../æ¶æ„è®¾è®¡æ–‡æ¡£.md)
- [APIä½¿ç”¨æ–‡æ¡£](./APIä½¿ç”¨æ–‡æ¡£.md)
- [ç¼–ç è§„èŒƒæ–‡æ¡£](./ç¼–ç è§„èŒƒæ–‡æ¡£.md)

## ğŸ“ æ›´æ–°æ—¥å¿—

### v1.0.0 (2025-10-17)
- âœ¨ åˆ›å»ºç»Ÿä¸€çš„ `ExceptionMapper`
- ğŸ”„ `ExceptionHandler` å’Œ `ErrorMapper` æ ‡è®°ä¸ºåºŸå¼ƒ
- ğŸš€ `ErrorHandlingInterceptor` ç®€åŒ–å¹¶ä½¿ç”¨ `ExceptionMapper`
- ğŸ“ æ”¯æŒ13ç§å¼‚å¸¸ç±»å‹çš„ç»Ÿä¸€æ˜ å°„
- ğŸ¯ æ¶ˆé™¤ä»£ç é‡å¤ï¼Œæå‡å¯ç»´æŠ¤æ€§

